{% extends "base.html" %}

{% block title %}Search Contracts - Government Contract Indexer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i data-feather="search" class="me-2"></i>
            Search Government Contracts
        </h1>
    </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form id="search-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="search-query" class="form-label">Search Query</label>
                                <input type="text" class="form-control" id="search-query" 
                                       placeholder="Enter keywords, technologies, or requirements..." required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="search-limit" class="form-label">Results Limit</label>
                                <select class="form-select" id="search-limit">
                                    <option value="10">10 results</option>
                                    <option value="20" selected>20 results</option>
                                    <option value="50">50 results</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i data-feather="search" class="me-2"></i>
                                    Search
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-analysis" checked>
                                <label class="form-check-label" for="include-analysis">
                                    Include AI Analysis and Recommendations
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Search Results -->
<div id="search-results" style="display: none;">
    <!-- AI Analysis Section -->
    <div id="ai-analysis-section" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info">
                    <h5 class="card-title mb-0 text-white">
                        <i data-feather="zap" class="me-2"></i>
                        AI Analysis & Recommendations
                    </h5>
                </div>
                <div class="card-body" id="ai-analysis-content">
                    <!-- AI analysis will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Summary -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h3 id="results-title">Search Results</h3>
                <div class="text-muted">
                    <span id="results-count">0</span> results found in <span id="response-time">0</span>s
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="results-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="contracts-tab" data-bs-toggle="tab" 
                            data-bs-target="#contracts-pane" type="button" role="tab">
                        <i data-feather="file-text" class="me-2"></i>
                        Contracts (<span id="contracts-count">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documents-tab" data-bs-toggle="tab" 
                            data-bs-target="#documents-pane" type="button" role="tab">
                        <i data-feather="file" class="me-2"></i>
                        Documents (<span id="documents-count">0</span>)
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="results-tab-content">
                <!-- Contracts Tab -->
                <div class="tab-pane fade show active" id="contracts-pane" role="tabpanel">
                    <div id="contracts-results" class="mt-3">
                        <!-- Contract results will be populated here -->
                    </div>
                </div>
                
                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents-pane" role="tabpanel">
                    <div id="documents-results" class="mt-3">
                        <!-- Document results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="search-loading" style="display: none;">
    <div class="row">
        <div class="col-12 text-center">
            <div class="card">
                <div class="card-body">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="mt-3 mb-0">Searching government contracts and analyzing results...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- No Results -->
<div id="no-results" style="display: none;">
    <div class="row">
        <div class="col-12 text-center">
            <div class="card">
                <div class="card-body">
                    <i data-feather="search" class="text-muted mb-3" style="width: 64px; height: 64px;"></i>
                    <h4>No Results Found</h4>
                    <p class="text-muted">Try adjusting your search terms or check back later as we continue to index new contracts.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    
    // Handle search form submission
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    // Auto-focus search input
    document.getElementById('search-query').focus();
});

async function performSearch() {
    const query = document.getElementById('search-query').value.trim();
    const limit = parseInt(document.getElementById('search-limit').value);
    const includeAnalysis = document.getElementById('include-analysis').checked;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    // Show loading, hide other sections
    showSection('search-loading');
    hideSection('search-results');
    hideSection('no-results');
    
    try {
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: query,
                limit: limit,
                include_analysis: includeAnalysis
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displayResults(data);
        } else {
            throw new Error(data.error || 'Search failed');
        }
        
    } catch (error) {
        console.error('Search error:', error);
        hideSection('search-loading');
        alert(`Search failed: ${error.message}`);
    }
}

function displayResults(data) {
    hideSection('search-loading');
    
    const { results, ai_analysis, response_time } = data;
    const totalResults = results.total_results || 0;
    
    if (totalResults === 0) {
        showSection('no-results');
        return;
    }
    
    // Update results summary
    document.getElementById('results-count').textContent = totalResults;
    document.getElementById('response-time').textContent = response_time.toFixed(3);
    document.getElementById('contracts-count').textContent = results.contracts.length;
    document.getElementById('documents-count').textContent = results.documents.length;
    
    // Display AI analysis if available
    if (ai_analysis && !ai_analysis.error) {
        displayAIAnalysis(ai_analysis);
        showSection('ai-analysis-section');
    } else {
        hideSection('ai-analysis-section');
    }
    
    // Display contracts
    displayContracts(results.contracts);
    
    // Display documents
    displayDocuments(results.documents);
    
    showSection('search-results');
    feather.replace();
}

function displayAIAnalysis(analysis) {
    const content = document.getElementById('ai-analysis-content');
    
    let html = '';
    
    // Summary
    if (analysis.summary) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="info" class="me-2"></i>Summary</h6>
                <p>${analysis.summary}</p>
            </div>
        `;
    }
    
    // Key Opportunities
    if (analysis.key_opportunities && analysis.key_opportunities.length > 0) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="star" class="me-2"></i>Key Opportunities</h6>
                <ul class="list-unstyled">
        `;
        analysis.key_opportunities.forEach(opportunity => {
            html += `<li class="mb-1"><i data-feather="chevron-right" class="me-2"></i>${opportunity}</li>`;
        });
        html += `</ul></div>`;
    }
    
    // Recommendations
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="lightbulb" class="me-2"></i>Recommendations</h6>
        `;
        analysis.recommendations.forEach(rec => {
            const priorityClass = rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'secondary';
            html += `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title">${rec.title}</h6>
                            <span class="badge bg-${priorityClass}">${rec.priority}</span>
                        </div>
                        <p class="card-text">${rec.description}</p>
                        ${rec.action_items && rec.action_items.length > 0 ? `
                            <ul class="list-unstyled mb-0">
                                ${rec.action_items.map(item => `<li class="small text-muted"><i data-feather="check" class="me-1"></i>${item}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Next Steps
    if (analysis.next_steps) {
        html += `
            <div class="alert alert-info">
                <h6><i data-feather="arrow-right" class="me-2"></i>Next Steps</h6>
                <p class="mb-0">${analysis.next_steps}</p>
            </div>
        `;
    }
    
    content.innerHTML = html;
}

function displayContracts(contracts) {
    const container = document.getElementById('contracts-results');
    
    if (contracts.length === 0) {
        container.innerHTML = '<p class="text-muted">No matching contracts found.</p>';
        return;
    }
    
    let html = '';
    
    contracts.forEach(contract => {
        const metadata = contract.metadata || {};
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">${metadata.title || 'Untitled Contract'}</h5>
                            <p class="card-text">${contract.content.substring(0, 300)}...</p>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                ${metadata.agency ? `<span class="badge bg-primary">${metadata.agency}</span>` : ''}
                                ${metadata.naics_code ? `<span class="badge bg-secondary">${metadata.naics_code}</span>` : ''}
                                ${metadata.classification_code ? `<span class="badge bg-info">${metadata.classification_code}</span>` : ''}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="text-muted small">
                                ${metadata.posted_date ? `<div><i data-feather="calendar" class="me-1"></i>${new Date(metadata.posted_date).toLocaleDateString()}</div>` : ''}
                                ${contract.distance !== undefined ? `<div class="mt-2"><i data-feather="target" class="me-1"></i>Relevance: ${(1 - contract.distance).toFixed(2)}</div>` : ''}
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="analyzeContract('${metadata.notice_id}')">
                                    <i data-feather="cpu" class="me-1"></i>Analyze
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function displayDocuments(documents) {
    const container = document.getElementById('documents-results');
    
    if (documents.length === 0) {
        container.innerHTML = '<p class="text-muted">No matching documents found.</p>';
        return;
    }
    
    let html = '';
    
    documents.forEach(doc => {
        const metadata = doc.metadata || {};
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="card-title">
                                <i data-feather="file" class="me-2"></i>
                                ${metadata.document_description || 'Document'}
                            </h6>
                            <p class="card-text small">${doc.content}</p>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                ${metadata.contract_notice_id ? `<span class="badge bg-primary">${metadata.contract_notice_id}</span>` : ''}
                                ${metadata.file_type ? `<span class="badge bg-secondary">${metadata.file_type.toUpperCase()}</span>` : ''}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="text-muted small">
                                ${metadata.text_length ? `<div><i data-feather="file-text" class="me-1"></i>${parseInt(metadata.text_length).toLocaleString()} chars</div>` : ''}
                                ${doc.distance !== undefined ? `<div class="mt-2"><i data-feather="target" class="me-1"></i>Relevance: ${(1 - doc.distance).toFixed(2)}</div>` : ''}
                            </div>
                            ${metadata.document_url ? `
                                <div class="mt-2">
                                    <a href="${metadata.document_url}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i data-feather="external-link" class="me-1"></i>View Document
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function analyzeContract(noticeId) {
    try {
        const response = await fetch(`/api/contracts/${noticeId}/analyze`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Display analysis in a modal or expand the card
            showContractAnalysis(data.analysis);
        } else {
            alert(`Analysis failed: ${data.error}`);
        }
    } catch (error) {
        alert(`Analysis failed: ${error.message}`);
    }
}

function showContractAnalysis(analysis) {
    console.log('Contract Analysis:', analysis);
    
    // Create a modal to display the analysis
    const modalHtml = `
        <div class="modal fade" id="analysisModal" tabindex="-1" aria-labelledby="analysisModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="analysisModalLabel">
                            <i data-feather="cpu" class="me-2"></i>
                            AI Contract Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${formatAnalysisResults(analysis)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('analysisModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
    modal.show();
    
    // Replace feather icons
    feather.replace();
}

function formatAnalysisResults(analysis) {
    let html = '';
    
    // Opportunity Assessment
    if (analysis.opportunity_assessment) {
        const assessmentClass = analysis.opportunity_assessment === 'high' ? 'success' : 
                               analysis.opportunity_assessment === 'medium' ? 'warning' : 'danger';
        html += `
            <div class="alert alert-${assessmentClass} mb-3">
                <h6><i data-feather="target" class="me-2"></i>Opportunity Assessment</h6>
                <p class="mb-0">This contract has <strong>${analysis.opportunity_assessment}</strong> potential for your business.</p>
            </div>
        `;
    }
    
    // Competition & Complexity
    html += '<div class="row mb-3">';
    if (analysis.competition_level) {
        const compClass = analysis.competition_level === 'high' ? 'danger' : 
                         analysis.competition_level === 'medium' ? 'warning' : 'success';
        html += `
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h6><i data-feather="users" class="me-2"></i>Competition Level</h6>
                        <span class="badge bg-${compClass} fs-6">${analysis.competition_level.toUpperCase()}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (analysis.bid_complexity) {
        const complexClass = analysis.bid_complexity === 'high' ? 'danger' : 
                            analysis.bid_complexity === 'medium' ? 'warning' : 'success';
        html += `
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h6><i data-feather="settings" class="me-2"></i>Bid Complexity</h6>
                        <span class="badge bg-${complexClass} fs-6">${analysis.bid_complexity.toUpperCase()}</span>
                    </div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    
    // Estimated Effort
    if (analysis.estimated_effort) {
        html += `
            <div class="alert alert-info mb-3">
                <h6><i data-feather="clock" class="me-2"></i>Estimated Effort</h6>
                <p class="mb-0">${analysis.estimated_effort}</p>
            </div>
        `;
    }
    
    // Key Requirements
    if (analysis.key_requirements && analysis.key_requirements.length > 0) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="check-square" class="me-2"></i>Key Requirements</h6>
                <ul class="list-group list-group-flush">
        `;
        analysis.key_requirements.forEach(req => {
            html += `<li class="list-group-item"><i data-feather="chevron-right" class="me-2"></i>${req}</li>`;
        });
        html += `</ul></div>`;
    }
    
    // Recommendations
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="lightbulb" class="me-2"></i>Recommendations</h6>
        `;
        analysis.recommendations.forEach(rec => {
            const priorityClass = rec.importance === 'high' ? 'danger' : 
                                 rec.importance === 'medium' ? 'warning' : 'secondary';
            html += `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="fw-bold">${rec.category.charAt(0).toUpperCase() + rec.category.slice(1)}</span>
                            <span class="badge bg-${priorityClass}">${rec.importance}</span>
                        </div>
                        <p class="card-text mt-2 mb-0">${rec.action}</p>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Red Flags
    if (analysis.red_flags && analysis.red_flags.length > 0) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="alert-triangle" class="me-2"></i>Red Flags</h6>
                <div class="alert alert-warning">
                    <ul class="mb-0">
        `;
        analysis.red_flags.forEach(flag => {
            html += `<li>${flag}</li>`;
        });
        html += `</ul></div></div>`;
    }
    
    // Success Factors
    if (analysis.success_factors && analysis.success_factors.length > 0) {
        html += `
            <div class="mb-4">
                <h6><i data-feather="star" class="me-2"></i>Success Factors</h6>
                <ul class="list-group list-group-flush">
        `;
        analysis.success_factors.forEach(factor => {
            html += `<li class="list-group-item"><i data-feather="check" class="me-2"></i>${factor}</li>`;
        });
        html += `</ul></div>`;
    }
    
    return html;
}

function showSection(id) {
    document.getElementById(id).style.display = 'block';
}

function hideSection(id) {
    document.getElementById(id).style.display = 'none';
}
</script>
{% endblock %}
