{% extends "base.html" %}

{% block title %}Dashboard - Government Contract Indexer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i data-feather="bar-chart-2" class="me-2"></i>
            Dashboard
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i data-feather="file-text" class="text-primary mb-2" style="width: 48px; height: 48px;"></i>
                <h3 class="card-title">{{ contracts_count }}</h3>
                <p class="card-text text-muted">Total Contracts</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i data-feather="database" class="text-success mb-2" style="width: 48px; height: 48px;"></i>
                <h3 class="card-title">{{ dashboard_stats.indexed_contracts }}</h3>
                <p class="card-text text-muted">Indexed Contracts</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i data-feather="file" class="text-info mb-2" style="width: 48px; height: 48px;"></i>
                <h3 class="card-title">{{ dashboard_stats.indexed_documents }}</h3>
                <p class="card-text text-muted">Indexed Documents</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i data-feather="search" class="text-warning mb-2" style="width: 48px; height: 48px;"></i>
                <h3 class="card-title">{{ dashboard_stats.recent_searches_count }}</h3>
                <p class="card-text text-muted">Recent Searches</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i data-feather="bell" class="text-secondary mb-2" style="width: 48px; height: 48px;"></i>
                <h3 class="card-title" id="processed-count">0</h3>
                <p class="card-text text-muted">Processed Documents</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="zap" class="me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-primary w-100" onclick="fetchContracts()">
                            <i data-feather="download" class="me-2"></i>
                            Fetch Contracts
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-success w-100" onclick="indexContracts()">
                            <i data-feather="upload" class="me-2"></i>
                            Index Contracts
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-info w-100" onclick="queueDocuments()">
                            <i data-feather="file-plus" class="me-2"></i>
                            Queue Documents
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-secondary w-100" onclick="checkStuckDocuments()">
                            <i data-feather="alert-circle" class="me-2"></i>
                            Check Status
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-danger w-100" onclick="stopProcessing()">
                            <i data-feather="stop-circle" class="me-2"></i>
                            Stop Processing
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-success w-100" onclick="resumeProcessing()">
                            <i data-feather="play-circle" class="me-2"></i>
                            Resume Processing
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('web.search') }}" class="btn btn-secondary w-100">
                            <i data-feather="search" class="me-2"></i>
                            Search Contracts
                        </a>
                    </div>
                </div>
                
                <!-- Test Mode Section -->
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">
                            <i data-feather="beaker" class="me-2"></i>
                            Test Mode (Cost-Controlled)
                        </h6>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-outline-info w-100" onclick="queueTestDocuments()">
                            <i data-feather="file-plus" class="me-2"></i>
                            Queue Test Docs (Max 7)
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-outline-warning w-100" onclick="processTestDocuments()">
                            <i data-feather="zap" class="me-2"></i>
                            Process Test Docs
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <small class="text-muted d-block text-center mt-2">
                            Limited to small documents<br>
                            Cost-effective testing
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Jobs and Notifications -->
<div class="row">
    <!-- Document Processing Status -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i data-feather="bell" class="me-2"></i>
                    Processing Status
                </h5>
                <div>
                    <span class="badge" id="queue-status-badge">Loading...</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshNotifications()">
                        <i data-feather="refresh-cw" class="me-1"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3 g-2">
                    <div class="col-4">
                        <div class="text-center text-primary">
                            <i data-feather="clock" class="mb-1" style="width: 16px; height: 16px;"></i>
                            <h6 class="mb-0" id="pending-queue-count">0</h6>
                            <small class="text-muted d-block text-truncate">Pending</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center text-warning">
                            <i data-feather="loader" class="mb-1" style="width: 16px; height: 16px;"></i>
                            <h6 class="mb-0" id="processing-queue-count">0</h6>
                            <small class="text-muted d-block text-truncate">Processing</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center text-success">
                            <i data-feather="check-circle" class="mb-1" style="width: 16px; height: 16px;"></i>
                            <h6 class="mb-0" id="completed-queue-count">0</h6>
                            <small class="text-muted d-block text-truncate">Done</small>
                        </div>
                    </div>
                </div>
                
                <div id="recent-notifications">
                    <div class="text-center text-muted">
                        <i data-feather="clock" class="mb-2"></i>
                        <p class="mb-0">Loading recent notifications...</p>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('web.notifications') }}" class="btn btn-outline-secondary btn-sm">
                        <i data-feather="eye" class="me-1"></i>
                        View All Notifications
                    </a>
                    <button class="btn btn-outline-warning btn-sm ms-2" onclick="checkStuckDocuments()">
                        <i data-feather="alert-triangle" class="me-1"></i>
                        Check Slow Jobs
                    </button>
                    <button class="btn btn-outline-info btn-sm ms-2" onclick="retryFailedDocuments()">
                        <i data-feather="refresh-ccw" class="me-1"></i>
                        Retry Failed
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Jobs -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="activity" class="me-2"></i>
                    Recent Jobs
                </h5>
            </div>
            <div class="card-body">
                {% if recent_jobs %}
                    <div class="list-group list-group-flush">
                        {% for job in recent_jobs %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ job.job_type.replace('_', ' ').title() }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ job.created_at.strftime('%Y-%m-%d %H:%M') if job.created_at }}
                                </small>
                            </div>
                            <div>
                                {% if job.status == 'completed' %}
                                    <span class="badge bg-success">{{ job.status }}</span>
                                {% elif job.status == 'failed' %}
                                    <span class="badge bg-danger">{{ job.status }}</span>
                                {% elif job.status == 'running' %}
                                    <span class="badge bg-primary">{{ job.status }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ job.status }}</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ job.records_processed }} processed</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ url_for('web.jobs') }}" class="btn btn-outline-secondary btn-sm">
                            View All Jobs
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted">No recent jobs found.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Searches -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="search" class="me-2"></i>
                    Recent Searches
                </h5>
            </div>
            <div class="card-body">
                {% if recent_searches %}
                    <div class="list-group list-group-flush">
                        {% for search in recent_searches[:5] %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{ search.query_text[:50] }}{% if search.query_text|length > 50 %}...{% endif %}</strong>
                                <small class="text-muted">{{ search.results_count }} results</small>
                            </div>
                            <small class="text-muted">
                                {{ search.created_at.strftime('%Y-%m-%d %H:%M') if search.created_at }}
                                {% if search.response_time %}
                                    | {{ "%.3f"|format(search.response_time) }}s
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No recent searches found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Job Progress Modal -->
<div class="modal fade" id="jobProgressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Job Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="job-progress-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Starting job...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let jobProgressModal;

document.addEventListener('DOMContentLoaded', function() {
    jobProgressModal = new bootstrap.Modal(document.getElementById('jobProgressModal'));
    feather.replace();
    
    // Load initial notification data
    refreshNotifications();
    
    // Auto-refresh notifications every 30 seconds
    setInterval(refreshNotifications, 30000);
    
    // Initialize live processing monitor for 5x faster updates
    if (typeof LiveProcessingMonitor !== 'undefined') {
        window.liveMonitor = new LiveProcessingMonitor();
        window.liveMonitor.start();
        
        // Immediately update counters on page load
        updateDashboardCounters();
    }
    
    // Manual function to update dashboard counters
    window.updateDashboardCounters = updateDashboardCounters;
    
    // Make checkStuckDocuments globally available
    window.checkStuckDocuments = checkStuckDocuments;
});

async function updateDashboardCounters() {
    try {
        const response = await fetch('/api/documents/queue/status');
        const data = await response.json();
        
        if (data.success && data.queue_status) {
            const status = data.queue_status;
            
            // Update main dashboard counters
            const pendingElement = document.getElementById('pending-queue-count');
            const processingElement = document.getElementById('processing-queue-count');
            const completedElement = document.getElementById('completed-queue-count');
            const statusBadge = document.getElementById('queue-status-badge');

            if (pendingElement) pendingElement.textContent = status.queued || 0;
            if (processingElement) processingElement.textContent = status.processing || 0;
            if (completedElement) completedElement.textContent = status.completed || 0;
            
            if (statusBadge) {
                statusBadge.textContent = status.is_processing ? 'Running' : 'Stopped';
                statusBadge.className = status.is_processing ? 'badge bg-success' : 'badge bg-secondary';
            }
        }
    } catch (error) {
        console.error('Failed to update dashboard counters:', error);
    }
}

async function checkStuckDocuments() {
    try {
        const response = await fetch('/api/admin/documents/stuck');
        const data = await response.json();
        
        if (data.success && data.stuck_documents.length > 0) {
            let message = `Found ${data.count} slow-running documents:\n\n`;
            data.stuck_documents.forEach(doc => {
                message += `• ${doc.filename} (${doc.processing_time_minutes} min)\n`;
            });
            message += '\nWould you like to reset these documents to retry processing?';
            
            if (confirm(message)) {
                const resetResponse = await fetch('/api/admin/documents/reset-all-stuck', {
                    method: 'POST'
                });
                const resetData = await resetResponse.json();
                
                if (resetData.success) {
                    alert(`Successfully reset ${resetData.reset_count} documents. They will be reprocessed.`);
                    updateDashboardCounters();
                } else {
                    alert('Error resetting documents: ' + resetData.error);
                }
            }
        } else {
            alert('No slow-running documents found. All processing jobs are running normally.');
        }
    } catch (error) {
        console.error('Error checking stuck documents:', error);
        alert('Error checking slow documents. Please try again.');
    }
}

async function fetchContracts() {
    showJobProgress('Fetching contracts from SAM.gov...');
    
    try {
        const response = await fetch('/api/contracts/fetch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                limit: 100
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (result.contracts_processed > 0) {
                updateJobProgress(`✅ Successfully fetched ${result.contracts_processed} contracts`, 'success');
            } else {
                updateJobProgress(`ℹ️ ${result.message || 'No new contracts found'}`, 'info');
            }
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            updateJobProgress(`❌ Error: ${result.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        updateJobProgress(`❌ Error: ${error.message}`, 'error');
    }
}

async function indexContracts() {
    showJobProgress('Indexing contracts in vector database...');
    
    try {
        // Add timeout for long-running indexing operations
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
        
        const response = await fetch('/api/contracts/index', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                limit: 100
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (response.ok) {
            if (result.indexed_count > 0) {
                updateJobProgress(`✅ Successfully indexed ${result.indexed_count} contracts`, 'success');
            } else {
                updateJobProgress(`ℹ️ ${result.message || 'No contracts to index'}`, 'info');
            }
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            updateJobProgress(`❌ Error: ${result.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            updateJobProgress(`⏱️ Indexing is taking longer than expected. Please check the Jobs page for progress.`, 'warning');
        } else {
            updateJobProgress(`❌ Error: ${error.message}`, 'error');
        }
    }
}

async function queueDocuments() {
    showJobProgress('Resetting queue and downloading fresh documents...');
    
    try {
        const response = await fetch('/api/documents/queue', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            updateJobProgress(`✅ Queue reset! Downloaded ${result.queued_count} fresh documents`, 'success');
            setTimeout(() => {
                updateDashboardCounters();
                hideJobProgress();
            }, 2000);
        } else {
            updateJobProgress(`❌ Error: ${result.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        updateJobProgress(`❌ Error: ${error.message}`, 'error');
    }
}

async function stopProcessing() {
    showJobProgress('Stopping document processing...');
    
    try {
        const response = await fetch('/api/documents/queue/stop', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            updateJobProgress(`✅ ${result.message}`, 'success');
            setTimeout(() => {
                updateDashboardCounters();
                hideJobProgress();
            }, 2000);
        } else {
            updateJobProgress(`❌ Error: ${result.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        updateJobProgress(`❌ Error: ${error.message}`, 'error');
    }
}

async function resumeProcessing() {
    showJobProgress('Resuming document processing...');
    
    try {
        const response = await fetch('/api/documents/queue/resume', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            updateJobProgress(`✅ ${result.message}`, 'success');
            setTimeout(() => {
                updateDashboardCounters();
                hideJobProgress();
            }, 2000);
        } else {
            updateJobProgress(`❌ Error: ${result.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        updateJobProgress(`❌ Error: ${error.message}`, 'error');
    }
}





function showJobProgress(message) {
    document.getElementById('job-progress-content').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">${message}</p>
        </div>
    `;
    jobProgressModal.show();
}

function updateJobProgress(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    
    document.getElementById('job-progress-content').innerHTML = `
        <div class="alert ${alertClass}" role="alert">
            ${message}
        </div>
    `;
}

function hideJobProgress() {
    if (jobProgressModal) {
        jobProgressModal.hide();
    }
}

// Notification system functions
async function refreshNotifications() {
    try {
        // Fetch queue status
        const queueResponse = await fetch('/api/documents/queue/status');
        const queueData = await queueResponse.json();
        
        if (queueData.success) {
            updateQueueStatus(queueData);
        }
        
        // Fetch notifications
        const notificationResponse = await fetch('/api/documents/notifications');
        const notificationData = await notificationResponse.json();
        
        if (notificationData.success) {
            updateProcessedCount(notificationData.total_processed);
            displayRecentNotifications(notificationData.notifications);
        }
        
    } catch (error) {
        console.error('Error refreshing notifications:', error);
    }
}

function updateQueueStatus(data) {
    // Update queue status badge
    const statusBadge = document.getElementById('queue-status-badge');
    if (data.is_processing) {
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Active';
    } else {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.textContent = 'Stopped';
    }
    
    // Update queue counts
    document.getElementById('pending-queue-count').textContent = data.pending_count || 0;
    document.getElementById('processing-queue-count').textContent = data.processing_count || 0;
    document.getElementById('completed-queue-count').textContent = data.completed_count || 0;
}

function updateProcessedCount(count) {
    document.getElementById('processed-count').textContent = count;
}

function displayRecentNotifications(notifications) {
    const container = document.getElementById('recent-notifications');
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i data-feather="inbox" class="mb-2"></i>
                <p class="mb-0">No notifications yet</p>
            </div>
        `;
        feather.replace();
        return;
    }
    
    // Show only the 3 most recent notifications
    const recentNotifications = notifications.slice(0, 3);
    
    container.innerHTML = recentNotifications.map(notification => {
        const fileName = notification.original_file ? 
            notification.original_file.split('/').pop() : 'Unknown File';
        const timestamp = new Date(notification.processed_timestamp).toLocaleString();
        
        return `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1 small">${fileName}</h6>
                        <small class="text-muted">${timestamp}</small>
                    </div>
                    <div>
                        <span class="badge bg-success">
                            <i data-feather="check" class="me-1"></i>
                            Completed
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    feather.replace();
}

// Test mode functions
async function queueTestDocuments() {
    try {
        showAlert('info', 'Queueing test documents (max 7, ≤5 pages each)...');
        
        const response = await fetch('/api/documents/queue/test-mode', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', `${data.message} (${data.queued_count} documents)`);
            refreshNotifications(); // Update status
        } else {
            showAlert('danger', `Failed to queue test documents: ${data.error}`);
        }
    } catch (error) {
        showAlert('danger', `Error queueing test documents: ${error.message}`);
    }
}

async function processTestDocuments() {
    try {
        showAlert('info', 'Processing test documents with cost monitoring...');
        
        const response = await fetch('/api/documents/queue/test-process', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', `${data.message} (${data.processed_count} documents)`);
            refreshNotifications(); // Update status
        } else {
            showAlert('danger', `Failed to process test documents: ${data.error}`);
        }
    } catch (error) {
        showAlert('danger', `Error processing test documents: ${error.message}`);
    }
}
</script>
{% endblock %}
